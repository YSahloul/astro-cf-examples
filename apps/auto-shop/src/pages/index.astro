---
import { env } from "cloudflare:workers";
import Layout from "@/layouts/Layout.astro";
import Navbar from "@/components/Navbar.astro";
import HeroSection from "@/components/HeroSection.astro";
import BrandMarquee from "@/components/BrandMarquee.astro";
import GallerySection from "@/components/GallerySection.astro";
import HoursSection from "@/components/HoursSection.astro";
import TestimonialsSection from "@/components/TestimonialsSection.astro";
import CtaSection from "@/components/CtaSection.astro";
import Footer from "@/components/Footer.astro";
import FitmentRecommendations from "@/components/FitmentRecommendations";
import { FitmentQuiz } from "@/components/FitmentQuiz";
import { AppointmentScheduler } from "@/components/AppointmentScheduler";
import { createContentClient, getProfile, getServices, getHours, getTestimonials } from "@/lib/content";

const client = createContentClient(env.PAYLOAD_CMS);

const [profile, services, hours, testimonials] = await Promise.all([
  getProfile(client),
  getServices(client),
  getHours(client),
  getTestimonials(client),
]);

// Transform profile for components (flatten nested objects)
const profileData = profile ? {
  name: profile.name,
  tagline: profile.tagline,
  description: profile.description,
  phone: profile.phone,
  email: profile.email,
  address: profile.address?.street,
  city: profile.address?.city,
  state: profile.address?.state,
  zip: profile.address?.zip,
  instagram: profile.social?.instagram,
  facebook: profile.social?.facebook,
  financingUrl: profile.financingUrl,
  heroImage: typeof profile.heroImage === 'object' ? profile.heroImage?.url : null,
} : { name: "Auto Shop" };

// Transform hours for components (capitalize day names)
const hoursData = hours.map(h => ({
  ...h,
  day: h.day.charAt(0).toUpperCase() + h.day.slice(1),
}));

// Gallery not yet migrated to Payload - use empty array for now
const gallery: any[] = [];
---

<Layout title={profileData.name}>
  <Navbar name={profileData.name} phone={profileData.phone} />

  <HeroSection profile={profileData} />
  
  <FitmentRecommendations client:load />
  
  <FitmentQuiz client:load isOpen={false} onClose={() => {}} />

  <BrandMarquee />

  <section id="services" class="bg-base-200 py-16 md:py-24">
    <div class="max-w-5xl mx-auto px-4">
      <AppointmentScheduler client:load services={services.map((s) => ({ id: s.id, name: s.name }))} />
    </div>
  </section>

  <GallerySection gallery={gallery} instagram={profileData.instagram} />

  <HoursSection hours={hoursData} profile={profileData} />

  <TestimonialsSection testimonials={testimonials} />

  <CtaSection phone={profileData.phone} />

  <Footer 
    name={profileData.name} 
    phone={profileData.phone}
    address={profileData.address}
    city={profileData.city}
    state={profileData.state}
    zip={profileData.zip}
    instagram={profileData.instagram}
    facebook={profileData.facebook}
  />
</Layout>
