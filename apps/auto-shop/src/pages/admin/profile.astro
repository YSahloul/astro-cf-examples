---
import { env } from "cloudflare:workers";
import Layout from "@/layouts/Layout.astro";
import { ProfileForm } from "@/components/ProfileForm";
import { createContentClient, getProfile } from "@/lib/content";

const client = createContentClient(env.PAYLOAD_CMS);
const profileResult = await getProfile(client);

// Transform profile for the form (flatten nested objects)
const profile = profileResult ? {
  id: profileResult.id,
  name: profileResult.name,
  tagline: profileResult.tagline,
  description: profileResult.description,
  phone: profileResult.phone,
  email: profileResult.email,
  address: profileResult.address?.street,
  city: profileResult.address?.city,
  state: profileResult.address?.state,
  zip: profileResult.address?.zip,
  heroImage: typeof profileResult.heroImage === 'object' ? profileResult.heroImage?.url : null,
  instagram: profileResult.social?.instagram,
  facebook: profileResult.social?.facebook,
  financingUrl: profileResult.financingUrl,
} : { name: "Auto Shop" };
---

<Layout title="Edit Profile" isAdmin>
  <div class="space-y-6">
    <div class="flex justify-between items-center">
      <h1 class="text-3xl font-black">Edit Profile</h1>
      <a href="/admin" class="btn btn-ghost btn-sm gap-2">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="m15 18-6-6 6-6"/></svg>
        Back to Dashboard
      </a>
    </div>
    <div class="card bg-base-100 shadow-xl">
      <div class="card-body">
        <ProfileForm profile={profile} client:load />
      </div>
    </div>
  </div>
</Layout>
