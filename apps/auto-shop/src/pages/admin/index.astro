---
import { env } from "cloudflare:workers";
import Layout from "@/layouts/Layout.astro";
import { getDb, profile as profileTable, services as servicesTable, testimonials as testimonialsTable, leads as leadsTable } from "@/db";

const db = getDb(env.DB);

const [profileResult, servicesResult, testimonialsResult, leadsResult] = await Promise.all([
  db.select().from(profileTable).limit(1),
  db.select().from(servicesTable),
  db.select().from(testimonialsTable),
  db.select().from(leadsTable),
]);

const profile = profileResult[0] || { name: "Auto Shop" };
const services = servicesResult;
const testimonials = testimonialsResult;
const leads = leadsResult;
const newLeads = leads.filter(l => l.status === "new").length;
---

<Layout title="Admin Dashboard" isAdmin>
  <div class="mb-8">
    <h1 class="text-3xl font-black tracking-tight">Dashboard</h1>
    <p class="opacity-60 mt-1">Welcome back! Here's an overview of your shop.</p>
  </div>
  
  <!-- Stats Grid -->
  <div class="stats stats-vertical md:stats-horizontal shadow w-full mb-8">
    <div class="stat">
      <div class="stat-figure text-primary">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
      </div>
      <div class="stat-title">Business</div>
      <div class="stat-value text-lg">{profile.name}</div>
    </div>
    
    <div class="stat">
      <div class="stat-figure text-info">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>
      </div>
      <div class="stat-title">Services</div>
      <div class="stat-value">{services.length}</div>
    </div>
    
    <div class="stat">
      <div class="stat-figure text-warning">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
      </div>
      <div class="stat-title">Testimonials</div>
      <div class="stat-value">{testimonials.length}</div>
    </div>
    
    <div class="stat">
      <div class="stat-figure text-primary">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
      </div>
      <div class="stat-title">New Leads</div>
      <div class="stat-value text-primary">{newLeads}</div>
    </div>
  </div>

  <!-- Actions & Info -->
  <div class="grid md:grid-cols-2 gap-6">
    <div class="card bg-base-100 shadow-xl">
      <div class="card-body">
        <h2 class="card-title">Quick Actions</h2>
        <div class="space-y-3 mt-2">
          <a href="/admin/leads" class="btn btn-primary btn-block justify-between">
            View Leads ({leads.length})
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="m9 18 6-6-6-6"/></svg>
          </a>
          <a href="/admin/profile" class="btn btn-ghost btn-block justify-between">
            Edit Profile
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="m9 18 6-6-6-6"/></svg>
          </a>
          <a href="/admin/services" class="btn btn-ghost btn-block justify-between">
            Manage Services
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="m9 18 6-6-6-6"/></svg>
          </a>
          <a href="/" target="_blank" class="btn btn-outline btn-block justify-between">
            View Live Site
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" x2="21" y1="14" y2="3"/></svg>
          </a>
        </div>
      </div>
    </div>

    <div class="card bg-base-100 shadow-xl">
      <div class="card-body">
        <h2 class="card-title">Contact Info</h2>
        <div class="space-y-4 mt-2">
          <div class="flex items-center gap-3">
            <div class="btn btn-circle btn-ghost btn-sm bg-primary/10">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>
            </div>
            <div>
              <p class="text-xs font-medium opacity-60 uppercase tracking-wide">Phone</p>
              <p class="font-semibold">{profile.phone || "Not set"}</p>
            </div>
          </div>
          <div class="flex items-center gap-3">
            <div class="btn btn-circle btn-ghost btn-sm bg-primary/10">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><rect width="20" height="16" x="2" y="4" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/></svg>
            </div>
            <div>
              <p class="text-xs font-medium opacity-60 uppercase tracking-wide">Email</p>
              <p class="font-semibold">{profile.email || "Not set"}</p>
            </div>
          </div>
          <div class="flex items-center gap-3">
            <div class="btn btn-circle btn-ghost btn-sm bg-primary/10">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M20 10c0 4.993-5.539 10.193-7.399 11.799a1 1 0 0 1-1.202 0C9.539 20.193 4 14.993 4 10a8 8 0 0 1 16 0"/><circle cx="12" cy="10" r="3"/></svg>
            </div>
            <div>
              <p class="text-xs font-medium opacity-60 uppercase tracking-wide">Address</p>
              <p class="font-semibold">{profile.address ? `${profile.address}, ${profile.city}` : "Not set"}</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</Layout>
