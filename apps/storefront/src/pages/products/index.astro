---
import Layout from '../../layouts/Layout.astro';
import { createPayload, type Product, type Media, TENANT_ID } from '../../lib/payload';

const payload = createPayload(Astro.locals.runtime?.env?.PAYLOAD_CMS);

const page = Number(Astro.url.searchParams.get('page')) || 1;
let products: Product[] = [];
let totalPages = 1;
let error: string | null = null;

try {
  const response = await payload.find({
    collection: 'products',
    where: { 
      _status: { equals: 'published' },
      tenant: { equals: TENANT_ID },
    },
    limit: 12,
    page,
  });
  products = response.docs;
  totalPages = response.totalPages;
} catch (e) {
  error = e instanceof Error ? e.message : 'Failed to load products';
}

function getImageUrl(product: Product): string | null {
  const firstImage = product.images?.[0];
  if (!firstImage) return null;
  const media = firstImage.image;
  if (typeof media === 'number') return null;
  return (media as Media)?.url || null;
}
---

<Layout title="Products - Astro Store">
  <h1 class="text-3xl font-bold text-gray-900 mb-8">All Products</h1>

  {error && (
    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
      <p class="text-yellow-800">Unable to load products.</p>
      <p class="text-yellow-600 text-sm mt-1">{error}</p>
    </div>
  )}

  {products.length === 0 && !error && (
    <div class="text-center py-12 bg-gray-100 rounded-lg">
      <p class="text-gray-600">No products available yet.</p>
    </div>
  )}

  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
    {products.map((product) => {
      const imageUrl = getImageUrl(product);
      return (
        <a href={`/products/${product.slug || product.id}`} class="bg-white rounded-lg shadow-sm overflow-hidden hover:shadow-md transition group">
          <div class="aspect-square bg-gray-200 flex items-center justify-center">
            {imageUrl ? (
              <img src={imageUrl} alt={product.images?.[0]?.alt || product.title || ''} class="w-full h-full object-cover" />
            ) : (
              <span class="text-gray-400">No image</span>
            )}
          </div>
          <div class="p-4">
            <h2 class="font-medium text-gray-900 group-hover:text-blue-600 transition">{product.title}</h2>
            {product.shortDescription && <p class="text-sm text-gray-500 mt-1 line-clamp-2">{product.shortDescription}</p>}
            {product.priceInUSDEnabled && product.priceInUSD != null && (
              <p class="text-lg font-bold text-gray-900 mt-1">${product.priceInUSD.toFixed(2)}</p>
            )}
            <p class={`text-sm mt-1 ${(product.inventory ?? 0) > 0 ? 'text-green-600' : 'text-red-600'}`}>
              {(product.inventory ?? 0) > 0 ? `${product.inventory} in stock` : 'Out of stock'}
            </p>
          </div>
        </a>
      );
    })}
  </div>

  {totalPages > 1 && (
    <nav class="flex justify-center gap-2 mt-8">
      {page > 1 && <a href={`/products?page=${page - 1}`} class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">Previous</a>}
      {Array.from({ length: totalPages }, (_, i) => i + 1).map((p) => (
        <a href={`/products?page=${p}`} class={`px-4 py-2 border rounded-lg ${p === page ? 'bg-blue-600 text-white border-blue-600' : 'border-gray-300 hover:bg-gray-50'}`}>{p}</a>
      ))}
      {page < totalPages && <a href={`/products?page=${page + 1}`} class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">Next</a>}
    </nav>
  )}
</Layout>
