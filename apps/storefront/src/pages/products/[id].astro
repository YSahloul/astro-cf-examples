---
import Layout from '../../layouts/Layout.astro';
import { createPayload, getProductByIdOrSlug, type Product, type Variant, type Media } from '../../lib/payload';
import { actions } from 'astro:actions';

const payload = createPayload(Astro.locals.runtime?.env?.PAYLOAD_CMS);
const { id } = Astro.params;

let product: Product | null = null;
let variants: Variant[] = [];
let error: string | null = null;

try {
  product = await getProductByIdOrSlug(payload, id!);
  if (product.enableVariants) {
    const variantsResponse = await payload.find({
      collection: 'variants',
      where: { product: { equals: product.id }, _status: { equals: 'published' } },
    });
    variants = variantsResponse.docs;
  }
} catch (e) {
  error = e instanceof Error ? e.message : 'Failed to load product';
}

const result = Astro.getActionResult(actions.addToCart);

function getImageUrl(product: Product, index = 0): string | null {
  const img = product.images?.[index];
  if (!img) return null;
  const media = img.image;
  if (typeof media === 'number') return null;
  return (media as Media)?.url || null;
}
---

<Layout title={product?.title || 'Product'}>
  {error && (
    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
      <p class="text-red-800">Unable to load product.</p>
      <p class="text-red-600 text-sm mt-1">{error}</p>
      <a href="/products" class="text-blue-600 hover:underline mt-2 inline-block">Back to products</a>
    </div>
  )}

  {product && (
    <div class="grid md:grid-cols-2 gap-8">
      <div>
        <div class="aspect-square bg-gray-200 rounded-lg flex items-center justify-center overflow-hidden">
          {getImageUrl(product) ? (
            <img src={getImageUrl(product)!} alt={product.images?.[0]?.alt || product.title || ''} class="w-full h-full object-cover" />
          ) : (
            <span class="text-gray-400 text-lg">No image available</span>
          )}
        </div>
        {product.images && product.images.length > 1 && (
          <div class="grid grid-cols-4 gap-2 mt-4">
            {product.images.map((img, idx) => {
              const media = img.image as Media;
              return media?.url ? (
                <div class="aspect-square bg-gray-200 rounded overflow-hidden">
                  <img src={media.url} alt={img.alt || `${product.title} - Image ${idx + 1}`} class="w-full h-full object-cover" />
                </div>
              ) : null;
            })}
          </div>
        )}
      </div>

      <div>
        {product.category && <p class="text-sm text-blue-600 font-medium mb-2">{product.category}</p>}
        <h1 class="text-3xl font-bold text-gray-900 mb-4">{product.title}</h1>
        {product.shortDescription && <p class="text-gray-600 mb-4">{product.shortDescription}</p>}
        {product.priceInUSDEnabled && product.priceInUSD != null && (
          <p class="text-3xl font-bold text-gray-900 mb-4">${product.priceInUSD.toFixed(2)}</p>
        )}
        <p class={`mb-6 ${(product.inventory ?? 0) > 0 ? 'text-green-600' : 'text-red-600'}`}>
          {(product.inventory ?? 0) > 0 ? `${product.inventory} in stock` : 'Out of stock'}
        </p>
        {product.sku && <p class="text-sm text-gray-500 mb-4">SKU: {product.sku}</p>}

        {result && !result.error && (
          <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
            <p class="text-green-800">Added to cart!</p>
            <a href="/cart" class="text-green-600 hover:underline text-sm">View cart</a>
          </div>
        )}
        {result?.error && (
          <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
            <p class="text-red-800">Failed to add to cart</p>
          </div>
        )}

        <form method="POST" action={actions.addToCart} class="space-y-4">
          <input type="hidden" name="productId" value={product.id} />
          {variants.length > 0 && (
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Select Variant</label>
              <select name="variantId" required class="w-full border border-gray-300 rounded-lg px-4 py-2">
                <option value="">Choose an option</option>
                {variants.map((variant) => (
                  <option value={variant.id}>
                    {variant.title || `Variant #${variant.id}`}
                    {variant.priceInUSDEnabled && variant.priceInUSD != null && ` - $${variant.priceInUSD.toFixed(2)}`}
                    {variant.inventory != null && ` (${variant.inventory} in stock)`}
                  </option>
                ))}
              </select>
            </div>
          )}
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Quantity</label>
            <input type="number" name="quantity" value="1" min="1" max={product.inventory || 99} class="w-24 border border-gray-300 rounded-lg px-4 py-2" />
          </div>
          <button type="submit" disabled={(product.inventory ?? 0) === 0} class="w-full bg-blue-600 text-white px-6 py-3 rounded-lg font-medium hover:bg-blue-700 transition disabled:bg-gray-400 disabled:cursor-not-allowed">
            {(product.inventory ?? 0) > 0 ? 'Add to Cart' : 'Out of Stock'}
          </button>
        </form>
        <a href="/products" class="inline-block mt-6 text-blue-600 hover:underline">&larr; Back to products</a>
      </div>
    </div>
  )}
</Layout>
