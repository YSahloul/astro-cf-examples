---
import Layout from '../layouts/Layout.astro';
import { createPayload, type Product, type Media, TENANT_ID } from '../lib/payload';

const payload = createPayload(Astro.locals.runtime?.env?.PAYLOAD_CMS);

let products: Product[] = [];
let error: string | null = null;

try {
  const response = await payload.find({
    collection: 'products',
    where: { 
      _status: { equals: 'published' },
      tenant: { equals: TENANT_ID },
    },
    limit: 6,
  });
  products = response.docs;
} catch (e) {
  console.error('Failed to fetch products:', e);
  error = e instanceof Error ? e.message : 'Failed to load products';
}

function getImageUrl(product: Product): string | null {
  const firstImage = product.images?.[0];
  if (!firstImage) return null;
  const media = firstImage.image;
  if (typeof media === 'number') return null;
  return (media as Media)?.url || null;
}
---

<Layout title="Astro Store - Home">
  <section class="text-center py-12">
    <h1 class="text-4xl font-bold text-gray-900 mb-4">Welcome to Astro Store</h1>
    <p class="text-lg text-gray-600 max-w-2xl mx-auto mb-8">
      A modern e-commerce storefront built with Astro, powered by Payload CMS, running on Cloudflare Workers.
    </p>
    <a href="/products" class="inline-block bg-blue-600 text-white px-6 py-3 rounded-lg font-medium hover:bg-blue-700 transition">
      Browse Products
    </a>
  </section>

  <section class="py-12">
    <h2 class="text-2xl font-bold text-gray-900 mb-6">Featured Products</h2>
    
    {error && (
      <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
        <p class="text-yellow-800">Unable to load products.</p>
        <p class="text-yellow-600 text-sm mt-1">{error}</p>
      </div>
    )}

    {products.length === 0 && !error && (
      <div class="text-center py-12 bg-gray-100 rounded-lg">
        <p class="text-gray-600">No products available yet.</p>
      </div>
    )}

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      {products.map((product) => {
        const imageUrl = getImageUrl(product);
        return (
          <a href={`/products/${product.slug || product.id}`} class="bg-white rounded-lg shadow-sm overflow-hidden hover:shadow-md transition group">
            <div class="aspect-square bg-gray-200 flex items-center justify-center">
              {imageUrl ? (
                <img src={imageUrl} alt={product.images?.[0]?.alt || product.title || ''} class="w-full h-full object-cover" />
              ) : (
                <span class="text-gray-400">No image</span>
              )}
            </div>
            <div class="p-4">
              <h3 class="font-medium text-gray-900 group-hover:text-blue-600 transition">{product.title}</h3>
              {product.shortDescription && <p class="text-sm text-gray-500 mt-1 line-clamp-2">{product.shortDescription}</p>}
              {product.priceInUSDEnabled && product.priceInUSD != null && (
                <p class="text-lg font-bold text-gray-900 mt-2">${product.priceInUSD.toFixed(2)}</p>
              )}
            </div>
          </a>
        );
      })}
    </div>
  </section>
</Layout>
